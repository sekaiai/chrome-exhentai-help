name: Auto Release Extension

# 仅在推送到主分支时触发自动发布
on:
  push:
    branches: [ main, master ]

jobs:
  auto-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予发布所需的权限
    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 配置 Node.js 环境
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 安装依赖并构建扩展
      - name: Install dependencies & build
        run: |
          npm install
          npm run build

      # 4. 打包扩展文件
      - name: Package extension
        run: zip -r chrome-exhentai-help.zip dist/

      # 5. 自动生成版本号（格式：v1.0.${运行编号}，运行编号递增且唯一）
      - name: Generate auto version
        id: generate_version
        run: echo "VERSION=v1.0.${{ github.run_number }}" >> $GITHUB_ENV

      # 6. 自动发布（创建 Release + 上传打包文件）
      - name: Auto release with asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}  # 使用自动生成的版本号作为标签
          name: Release ${{ env.VERSION }}  # Release 名称
          files: chrome-exhentai-help.zip  # 要上传的包文件
          draft: false  # 不创建草稿
          prerelease: false  # 非预发布版本
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub 内置令牌，无需手动配置
